<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Automatically Refresh My BATApply</title>
<script src="http://cdn.bootcss.com/jquery/2.1.3/jquery.min.js"></script>
<style>
.success{color: #9acd32}
.error{color:  #a52a2a}
</style>
</head>
<body>
<h1>Automatically Refresh My <span class="apply-type">BAT</span>Apply</h1>
<p id="start"></p>
<ul id="refresh-list"></ul>
<script type="text/javascript">
(function(){
	var applyType = '',
        stateNow = '', // 当前你的简历状态
        TIME_OUT = 80, // 多长秒刷新一次
		baseURL = location.href.replace(/[^\/]\w+\.html/,'api.php'),
		smsURL = baseURL+'?smsSend',
		state = false;
	// 获取当前状态，启动程序
	$.get(baseURL+'?stateNow', function(data){
		$('.apply-type').html(data.type);
		applyType = data.type;
        stateNow = data.now;
	    $('#start').html('<span class="success">程序已启动，当前状态：'+data.now+'</span>');
	    autoQuery();
	});
	// 自动刷新
	var autoQuery = function(){
		$.get(baseURL+'?stateRefresh', function(data){
			var time = (new Date()).toLocaleString();
			console.log('Time:', time);
			console.log('State:', data);
			if(data && data != stateNow){
				state = true;
				var message = applyType+'的应聘申请状态已更新！现在状态为：'+data+' Time:'+time;
				$.ajax({
					url: smsUrl+'&message='+decodeURIComponent(message),
					dataType: 'jsonp',
					jsonp: 'callback',
					async: false,
					success: function(sms){
						$('#refresh-list').prepend('<li class="success">&nbsp;&nbsp;&nbsp;'+data+'</li>');
						console.log('SMS', sms);
						// 更新简历比对状态，重新开始轮询
						stateNow = data;
						autoQuery();
					}
				});
			} else if(data){
				$('#refresh-list').prepend('<li>Refreshed At: '+time+'</li><li>&nbsp;&nbsp;&nbsp;Not Update!</li>');
			} else{
				$('#refresh-list').prepend('<li class="error">Refreshed At: '+time+'</li><li class="error">&nbsp;&nbsp;&nbsp;Failed!</li>');
			}
			if(!state){
				setTimeout(autoQuery, TIME_OUT*1000);
			}
		});
	};
})();
</script>
</body>
</html>